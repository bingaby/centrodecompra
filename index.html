<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Centro de Compras</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="logos/centrodecompras.jpg" alt="Centro de Compras" loading="lazy" id="site-logo">
    <h1>Centro de Compras</h1>
    <div class="social-links">
      <a href="https://www.instagram.com" target="_blank"><img src="logos/instagram.png" alt="Instagram" loading="lazy"></a>
      <a href="https://www.x.com" target="_blank"><img src="logos/x.png" alt="X" loading="lazy"></a>
    </div>
  </header>
  <div class="container">
    <aside class="sidebar-categorias">
      <h2>Categorias</h2>
      <select id="filtro-categoria">
        <option value="todas">Todas</option>
        <option value="Eletrônicos">Eletrônicos</option>
        <option value="Roupas">Roupas</option>
        <option value="Casa">Casa</option>
      </select>
      <h2>Lojas</h2>
      <select id="filtro-loja">
        <option value="todas">Todas</option>
        <option value="Amazon">Amazon</option>
        <option value="Mercado Livre">Mercado Livre</option>
        <option value="Shopee">Shopee</option>
      </select>
      <h2>Busca</h2>
      <input type="text" id="busca" placeholder="Digite o nome do produto">
      <button onclick="carregarProdutos()">Filtrar</button>
    </aside>
    <main>
      <div class="grid-produtos" id="grid-produtos"></div>
      <div id="paginacao"></div>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const API_BASE_URL = 'https://minha-api-produtos.onrender.com';
    const socket = io(API_BASE_URL);

    document.addEventListener('DOMContentLoaded', () => {
      // Manipulador de erro para imagens
      document.querySelectorAll('img').forEach(img => {
        img.onerror = () => {
          console.log(`Erro ao carregar imagem: ${img.src}`);
          img.src = '/imagens/placeholder.jpg';
        };
      });

      // Evento de clique triplo no logo
      const logo = document.getElementById("site-logo");
      if (!logo) {
        console.error("Elemento com ID 'site-logo' não encontrado");
      } else {
        let clickCount = 0, clickTimeout = null;
        logo.addEventListener("click", (e) => {
          console.log("Clique no logo:", clickCount + 1);
          e.stopPropagation();
          clickCount++;
          if (clickCount === 1) {
            clickTimeout = setTimeout(() => { clickCount = 0; }, 1000);
          } else if (clickCount === 3) {
            console.log("Tentando redirecionar para add-produtos.html");
            clearTimeout(clickTimeout);
            window.location.href = "/add-produtos.html";
            clickCount = 0;
          }
        });
      }

      // Carregar produtos
      async function carregarProdutos(page = 1) {
        const categoria = document.getElementById('filtro-categoria').value;
        const loja = document.getElementById('filtro-loja').value;
        const busca = document.getElementById('busca').value;
        const url = `${API_BASE_URL}/api/produtos?page=${page}&limit=12` +
                    `${categoria !== 'todas' ? `&categoria=${categoria}` : ''}` +
                    `${loja !== 'todas' ? `&loja=${loja}` : ''}` +
                    `${busca ? `&busca=${encodeURIComponent(busca)}` : ''}`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }
          const { data, total } = await response.json();
          const gridProdutos = document.getElementById('grid-produtos');
          gridProdutos.innerHTML = '';

          data.forEach(produto => {
            const div = document.createElement('div');
            div.className = 'produto';
            div.innerHTML = `
              <img src="${produto.imagens[0]}" alt="${produto.nome}" loading="lazy">
              <h3>${produto.nome}</h3>
              <p>${produto.descricao || 'Sem descrição'}</p>
              <p>R$ ${parseFloat(produto.preco).toFixed(2)}</p>
              <p>Categoria: ${produto.categoria}</p>
              <p>Loja: ${produto.loja}</p>
              <a href="${produto.link}" target="_blank">Ver Produto</a>
            `;
            gridProdutos.appendChild(div);
          });

          // Paginação
          const totalPages = Math.ceil(total / 12);
          const paginacao = document.getElementById('paginacao');
          paginacao.innerHTML = '';
          for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.onclick = () => carregarProdutos(i);
            if (i === page) button.disabled = true;
            paginacao.appendChild(button);
          }
        } catch (error) {
          console.error('Erro ao carregar produtos:', error);
          document.getElementById('grid-produtos').innerHTML = '<p>Erro ao carregar produtos</p>';
        }
      }

      // Eventos Socket.IO
      socket.on('novoProduto', () => {
        carregarProdutos();
      });
      socket.on('produtoExcluido', () => {
        carregarProdutos();
      });

      // Carregar produtos iniciais
      carregarProdutos();
    });
  </script>
</body>
</html>
