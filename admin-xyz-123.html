<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://script.google.com https://opensheet.vercel.app; img-src 'self' data: https://via.placeholder.com; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://fonts.gstatic.com/*; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'sha256-/iX0e2kW5U+6lyM7x0nC3G2lE8p1z3K7X5U8W4k5J8A=';">
  <title>Adicionar Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    form {
      max-width: 500px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    input, textarea, select, button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6" viewBox="0 0 12 6"><path fill="%23333" d="M0 0h12L6 6z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
    }
    button {
      background-color: #ff6200;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #e55a00;
    }
    button.secondary {
      background-color: #6c757d;
    }
    button.secondary:hover {
      background-color: #5a6268;
    }
    #mensagem {
      margin-top: 10px;
      color: green;
      text-align: center;
    }
    #erro {
      margin-top: 10px;
      color: red;
      text-align: center;
    }
    .produto-lista {
      margin-top: 20px;
      max-width: 500px;
      margin: auto;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .produto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 5px;
      font-size: 14px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .produto-item button {
      background-color: #d32f2f;
      color: white;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .produto-item button:hover {
      background-color: #b71c1c;
    }
    .produto-item img {
      max-width: 30px;
      max-height: 30px;
      margin-left: 8px;
      border-radius: 4px;
      object-fit: contain;
    }
    .produto-info {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .produto-info strong {
      font-size: 14px;
    }
    .produto-info span, .produto-info a {
      font-size: 12px;
      color: #666;
    }
    .paginacao {
      margin-top: 10px;
      text-align: center;
    }
    .paginacao button {
      background-color: #ff6200;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .paginacao button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .paginacao button:hover:not(:disabled) {
      background-color: #e55a00;
    }
    .form-buttons {
      display: flex;
      gap: 10px;
    }
    #preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #preview-container img {
      max-width: 100px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Adicionar Produto</h1>
  <form id="form-produto">
    <input type="hidden" id="idx">
    <input type="text" id="nome" placeholder="Nome do produto" required>
    <textarea id="descricao" placeholder="Descrição do produto"></textarea>
    <select id="categoria" required>
      <option value="" disabled selected>Selecione uma categoria</option>
      <option value="Eletrônicos">Eletrônicos</option>
      <option value="Moda">Moda</option>
      <option value="Fitness">Fitness</option>
      <option value="Casa">Casa e Decoração</option>
      <option value="Beleza">Beleza</option>
      <option value="Esportes">Esportes</option>
      <option value="Livros">Livros</option>
      <option value="Infantil">Infantil</option>
      <option value="Celulares">Celulares</option>
      <option value="Eletrodomésticos">Eletrodomésticos</option>
      <option value="Pet">Pet</option>
      <option value="Jardinagem">Jardinagem</option>
      <option value="Automotivo">Automotivo</option>
      <option value="Gastronomia">Gastronomia</option>
      <option value="Games">Games</option>
      <option value="Outros">Outros</option>
    </select>
    <select id="loja" required>
      <option value="" disabled selected>Selecione uma loja</option>
      <option value="Amazon">Amazon</option>
      <option value="Magalu">Magalu</option>
      <option value="Shein">Shein</option>
      <option value="Shopee">Shopee</option>
      <option value="Mercado Livre">Mercado Livre</option>
      <option value="Alibaba">Alibaba</option>
      <option value="Outros">Outros</option>
    </select>
    <input type="url" id="link" placeholder="Link do produto (https://...)" pattern="https?://.+">
    <input type="text" id="preco" placeholder="Preço (ex.: 99.90)">
    <input type="file" id="imagens" accept="image/*" multiple>
    <div id="preview-container"></div>
    <div class="form-buttons">
      <button type="submit">Adicionar</button>
      <button type="button" class="secondary" onclick="form.reset(); document.getElementById('categoria').value = ''; document.getElementById('loja').value = ''; document.getElementById('preview-container').innerHTML = '';">Limpar</button>
    </div>
  </form>
  <div id="mensagem"></div>
  <div id="erro"></div>
  <div class="produto-lista" id="produto-lista"></div>
  <div class="paginacao" id="paginacao"></div>

  <script>
    const URL_API = 'https://script.google.com/macros/s/AKfycbwgxT3zmouHq1p3AmJrOamfXEtf9VxWxqwy3Yw8iCZSe9OKPcWB7-vl4Gqgr_9xmAOI/exec';
    const SHEET_API = 'https://opensheet.vercel.app/1SMpUcrobcuWVGq4F_3N59rhs2_GpDo2531_2blpwEhs/Produtos';

    let isLoaded = false;
    let produtos = [];
    let paginaAtual = 1;
    const itensPorPagina = 20;

    function sanitizeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    async function desativarServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            console.log('Desativando Service Worker:', registration.scope);
            await registration.unregister();
          }
        } catch (error) {
          console.error('Erro ao desativar Service Worker:', error);
        }
      }
    }

    (function checkAccess() {
      const token = new URLSearchParams(window.location.search).get('tempToken');
      if (token !== 'triple-click-access') {
        alert('Acesso não autorizado. Você será redirecionado.');
        window.location.href = './index.html';
      }
    })();

    async function resizeImage(file, maxWidth, maxHeight) {
      return new Promise((resolve, reject) => {
        if (file.size > 2 * 1024 * 1024) {
          reject(new Error('Imagem muito grande. Máximo 2 MB.'));
        }
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          if (width > height) {
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = Math.round((width * maxHeight) / height);
              height = maxHeight;
            }
          }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(blob => {
            resolve(blob);
          }, 'image/jpeg', 0.8);
        };
        img.onerror = reject;
      });
    }

    const form = document.getElementById('form-produto');
    const imgInput = document.getElementById('imagens');
    const previewContainer = document.getElementById('preview-container');
    const listaProdutos = document.getElementById('produto-lista');
    const paginacao = document.getElementById('paginacao');
    const mensagem = document.getElementById('mensagem');
    const erro = document.getElementById('erro');

    imgInput.addEventListener('change', e => {
      previewContainer.innerHTML = '';
      const files = e.target.files;
      if (files.length > 3) {
        erro.textContent = 'Máximo de 3 imagens por produto!';
        mensagem.textContent = '';
        imgInput.value = '';
        return;
      }
      for (const file of files) {
        if (!file.type.startsWith('image/')) {
          erro.textContent = `Erro: O arquivo ${file.name} não é uma imagem válida.`;
          mensagem.textContent = '';
          imgInput.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          img.style.maxWidth = '100px';
          img.style.borderRadius = '4px';
          previewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      mensagem.textContent = 'Salvando produto...';
      erro.textContent = '';

      const valores = {
        nome: document.getElementById('nome').value.trim(),
        descricao: document.getElementById('descricao').value.trim(),
        categoria: document.getElementById('categoria').value.trim(),
        loja: document.getElementById('loja').value.trim(),
        link: document.getElementById('link').value.trim(),
        preco: document.getElementById('preco').value.trim(),
        rowIndex: document.getElementById('idx').value || null
      };

      const files = imgInput.files;
      if (files.length === 0) {
        erro.textContent = 'Pelo menos uma imagem deve ser escolhida!';
        mensagem.textContent = '';
        return;
      }
      if (files.length > 3) {
        erro.textContent = 'Máximo de 3 imagens por produto!';
        mensagem.textContent = '';
        return;
      }
      try {
        valores.imagensBase64 = await Promise.all(
          Array.from(files).map(async file => {
            const resizedBlob = await resizeImage(file, 300, 300);
            return new Promise(resolve => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.readAsDataURL(resizedBlob);
            });
          })
        );
      } catch (error) {
        erro.textContent = error.message || 'Erro ao processar as imagens.';
        mensagem.textContent = '';
        return;
      }

      try {
        const res = await fetch(URL_API, {
          method: 'POST',
          body: JSON.stringify(valores),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        if (!res.ok) {
          throw new Error(`Erro HTTP ${res.status}: ${res.statusText}`);
        }
        const json = await res.json();
        if (json.success) {
          mensagem.textContent = 'Produto salvo com sucesso!';
          erro.textContent = '';
          setTimeout(() => {
            form.reset();
            document.getElementById('categoria').value = '';
            document.getElementById('loja').value = '';
            document.getElementById('idx').value = '';
            previewContainer.innerHTML = '';
            carregar();
          }, 1500);
        } else {
          erro.textContent = 'Erro ao salvar: ' + (json.error || 'Erro desconhecido');
          mensagem.textContent = '';
        }
      } catch (error) {
        console.error('Erro ao salvar produto:', error);
        erro.textContent = 'Erro ao salvar: ' + error.message;
        mensagem.textContent = '';
      }
    });

    async function carregar() {
      if (isLoaded) {
        console.log('Função carregar() já foi executada, ignorando chamada repetida.');
        return;
      }
      isLoaded = true;
      console.log('Carregando produtos...');
      mensagem.textContent = 'Carregando produtos...';
      erro.textContent = '';
      try {
        const res = await fetch(SHEET_API, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`Erro HTTP ${res.status}: ${res.statusText}`);
        }
        produtos = await res.json();
        console.log('Produtos recebidos:', produtos.length);
        listaProdutos.innerHTML = '';
        if (produtos.length === 0) {
          listaProdutos.innerHTML = '<p>Nenhum produto adicionado ainda.</p>';
          paginacao.innerHTML = '';
          mensagem.textContent = '';
          console.log('Nenhum produto encontrado.');
          return;
        }
        // Remover duplicatas
        const uniqueProdutos = [];
        const seen = new Set();
        for (const p of produtos) {
          const key = `${p.nome}|${p.loja}|${p.link}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueProdutos.push(p);
          }
        }
        produtos = uniqueProdutos;
        console.log('Produtos únicos após filtragem:', produtos.length);
        paginaAtual = 1;
        exibirProdutos();
        mensagem.textContent = '';
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        erro.textContent = 'Erro ao carregar produtos: ' + error.message;
        mensagem.textContent = '';
        listaProdutos.innerHTML = '<p>Erro ao carregar produtos.</p>';
      }
    }

    function exibirProdutos() {
      listaProdutos.innerHTML = '';
      if (produtos.length === 0) {
        listaProdutos.innerHTML = '<p>Nenhum produto adicionado ainda.</p>';
        paginacao.innerHTML = '';
        return;
      }

      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const produtosPaginados = produtos.slice(inicio, fim);

      produtosPaginados.forEach((produto, index) => {
        const globalIndex = inicio + index;
        const divProduto = document.createElement('div');
        divProduto.classList.add('produto-item');
        const urlImg = produto.imagens?.split(',')[0] || 'https://via.placeholder.com/30';
        divProduto.innerHTML = `
          <div class="produto-info">
            <strong title="${sanitizeHTML(produto.nome)}">${sanitizeHTML(produto.nome)}</strong>
            <span>C: ${sanitizeHTML(produto.categoria)} | L: ${sanitizeHTML(produto.loja)}</span>
            <a href="${sanitizeHTML(produto.link)}" target="_blank" title="${sanitizeHTML(produto.link)}">Link</a>
          </div>
          <div>
            <img src="${sanitizeHTML(urlImg)}" alt="Imagem do produto" onerror="this.src='https://via.placeholder.com/30'">
            <button onclick="editar(${globalIndex})">Editar</button>
            <button onclick="removerProduto(${globalIndex})">Excluir</button>
          </div>
        `;
        listaProdutos.appendChild(divProduto);
      });

      const totalPaginas = Math.ceil(produtos.length / itensPorPagina);
      paginacao.innerHTML = `
        <button onclick="mudarPagina(${paginaAtual - 1})" ${paginaAtual === 1 ? 'disabled' : ''}>Anterior</button>
        <span>Página ${paginaAtual} de ${totalPaginas}</span>
        <button onclick="mudarPagina(${paginaAtual + 1})" ${paginaAtual === totalPaginas ? 'disabled' : ''}>Próximo</button>
      `;
    }

    function mudarPagina(novaPagina) {
      const totalPaginas = Math.ceil(produtos.length / itensPorPagina);
      if (novaPagina >= 1 && novaPagina <= totalPaginas) {
        paginaAtual = novaPagina;
        exibirProdutos();
      }
    }

    function editar(index) {
      const p = produtos[index];
      document.getElementById('nome').value = p.nome || '';
      document.getElementById('descricao').value = p.descricao || '';
      document.getElementById('categoria').value = p.categoria || '';
      document.getElementById('loja').value = p.loja || '';
      document.getElementById('link').value = p.link || '';
      document.getElementById('preco').value = p.preco || '';
      document.getElementById('idx').value = index + 2;
      previewContainer.innerHTML = p.imagens ? p.imagens.split(',').map(url => `<img src="${sanitizeHTML(url)}" alt="Imagem do produto" style="max-width: 100px; border-radius: 4px;">`).join('') : '';
      mensagem.textContent = 'Editando produto...';
      erro.textContent = '';
    }

    async function removerProduto(index) {
      if (!confirm(`Excluir o produto "${sanitizeHTML(produtos[index].nome)}"?`)) return;
      mensagem.textContent = 'Excluindo produto...';
      erro.textContent = '';
      const payload = { action: 'delete', rowIndex: index + 2 };
      try {
        const res = await fetch(URL_API, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        if (!res.ok) {
          throw new Error(`Erro HTTP ${res.status}: ${res.statusText}`);
        }
        const json = await res.json();
        if (json.success) {
          mensagem.textContent = 'Produto excluído com sucesso!';
          erro.textContent = '';
          setTimeout(() => {
            paginaAtual = Math.ceil((produtos.length - 1) / itensPorPagina) || 1;
            carregar();
          }, 1500);
        } else {
          erro.textContent = 'Erro ao excluir: ' + (json.error || 'Erro desconhecido');
          mensagem.textContent = '';
        }
      } catch (error) {
        console.error('Erro ao excluir produto:', error);
        erro.textContent = 'Erro ao excluir: ' + error.message;
        mensagem.textContent = '';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!isLoaded) {
        console.log('Iniciando carregamento da página admin...');
        desativarServiceWorker();
        carregar();
      }
    });
  </script>
</body>
</html>
