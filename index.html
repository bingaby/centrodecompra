<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Centro de Compras - Frontend Exemplo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #login, #products, #chat { margin-bottom: 30px; }
  #products { display: flex; flex-wrap: wrap; gap: 10px; }
  .product-card { border: 1px solid #ccc; padding: 10px; width: 150px; }
  #messages { border: 1px solid #ccc; height: 150px; overflow-y: auto; padding: 5px; margin-bottom: 10px; }
</style>
</head>
<body>

<h1>Centro de Compras - Frontend Exemplo</h1>

<section id="login">
  <h2>Login</h2>
  <input id="username" type="text" placeholder="Usuário" />
  <input id="password" type="password" placeholder="Senha" />
  <button id="btnLogin">Entrar</button>
  <p id="loginStatus" style="color:red;"></p>
</section>

<section id="products" style="display:none;">
  <h2>Produtos</h2>
  <div id="productsGrid"></div>
  <button id="btnLoadMore">Carregar Mais</button>
</section>

<section id="chat" style="display:none;">
  <h2>Chat Socket.io</h2>
  <div id="messages"></div>
  <input id="chatInput" type="text" placeholder="Digite uma mensagem" />
  <button id="sendMsg">Enviar</button>
</section>

<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<script>
  const API_URL = 'https://minha-api-produtos.onrender.com/api';
  let token = '';
  let page = 1;

  const loginSection = document.getElementById('login');
  const productsSection = document.getElementById('products');
  const chatSection = document.getElementById('chat');
  const loginStatus = document.getElementById('loginStatus');
  const productsGrid = document.getElementById('productsGrid');
  const btnLoadMore = document.getElementById('btnLoadMore');
  const messagesDiv = document.getElementById('messages');
  const chatInput = document.getElementById('chatInput');

  // Login
  document.getElementById('btnLogin').addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    loginStatus.textContent = '';

    if (!username || !password) {
      loginStatus.textContent = 'Preencha usuário e senha.';
      return;
    }

    try {
      const res = await fetch(API_URL + '/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password }),
      });
      const data = await res.json();
      if (data.success) {
        token = data.token;
        loginSection.style.display = 'none';
        productsSection.style.display = 'block';
        chatSection.style.display = 'block';
        carregarProdutos();
        iniciarSocket();
      } else {
        loginStatus.textContent = 'Usuário ou senha inválidos.';
      }
    } catch (err) {
      loginStatus.textContent = 'Erro ao conectar com a API.';
      console.error(err);
    }
  });

  // Carregar produtos
  async function carregarProdutos() {
    try {
      btnLoadMore.disabled = true;
      const res = await fetch(`${API_URL}/produtos?page=${page}&limit=10`, {
        headers: {
          Authorization: 'Bearer ' + token,
        },
      });
      const data = await res.json();
      if (data.success) {
        data.data.forEach(prod => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.innerHTML = `<strong>${prod.nome}</strong><br><small>${prod.descricao || ''}</small>`;
          productsGrid.appendChild(card);
        });
        if (data.data.length === 10) {
          btnLoadMore.disabled = false;
          page++;
        } else {
          btnLoadMore.style.display = 'none';
        }
      } else {
        alert('Erro ao carregar produtos.');
      }
    } catch (err) {
      alert('Erro na requisição.');
      console.error(err);
    }
  }

  btnLoadMore.addEventListener('click', carregarProdutos);

  // Socket.io
  let socket;
  function iniciarSocket() {
    socket = io('https://minha-api-produtos.onrender.com', {
      withCredentials: true,
      extraHeaders: {
        Origin: window.location.origin
      }
    });

    socket.on('connect', () => {
      console.log('Conectado ao socket:', socket.id);
      addMessage('Conectado ao chat.');
    });

    socket.on('mensagem', (msg) => {
      addMessage('Outro: ' + msg);
    });

    socket.on('disconnect', () => {
      addMessage('Desconectado do chat.');
    });

    socket.on('connect_error', (err) => {
      addMessage('Erro no socket: ' + err.message);
    });
  }

  document.getElementById('sendMsg').addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (!msg) return;
    socket.emit('mensagem', msg);
    addMessage('Você: ' + msg);
    chatInput.value = '';
  });

  function addMessage(text) {
    const p = document.createElement('p');
    p.textContent = text;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
</script>

</body>
</html>
