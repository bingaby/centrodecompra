<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    img-src 'self' data: https://drive.google.com https://*.googleusercontent.com;
    font-src 'self' https://fonts.gstatic.com;
    connect-src 'self' https://api-centro-de-compras.onrender.com;
  ">
  <title>Painel Administrativo - Centro de Compras</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <header>
    <div class="container">
      <h1>Painel Administrativo</h1>
      <a href="/index.html">Voltar ao Site</a>
    </div>
  </header>
  <main>
    <div class="container">
      <form id="produto-form">
        <h2>Adicionar/Editar Produto</h2>
        <label for="nome">Nome do Produto:</label>
        <input type="text" id="nome" name="nome" required>
        <label for="descricao">Descrição:</label>
        <textarea id="descricao" name="descricao"></textarea>
        <label for="categoria">Categoria:</label>
        <select id="categoria" name="categoria" required>
          <option value="eletronicos">Eletrônicos</option>
          <option value="roupas">Roupas</option>
          <option value="casa">Casa</option>
          <option value="esportes">Esportes</option>
        </select>
        <label for="loja">Loja:</label>
        <select id="loja" name="loja" required>
          <option value="amazon">Amazon</option>
          <option value="magalu">Magalu</option>
          <option value="shein">Shein</option>
          <option value="shopee">Shopee</option>
          <option value="mercadolivre">Mercado Livre</option>
          <option value="alibaba">Alibaba</option>
        </select>
        <label for="link">Link do Produto:</label>
        <input type="url" id="link" name="link" required>
        <label for="preco">Preço (R$):</label>
        <input type="number" id="preco" name="preco" step="0.01" required>
        <label for="imagens">Imagens:</label>
        <input type="file" id="imagens" name="imagens" accept="image/*" multiple>
        <div id="imagens-preview"></div>
        <input type="hidden" id="rowIndex" name="rowIndex">
        <button type="submit">Salvar Produto</button>
        <p id="feedback"></p>
      </form>
    </div>
  </main>
  <footer>
    <div class="container">
      <p>&copy; <span id="year"></span> Centro de Compras. Todos os direitos reservados.</p>
    </div>
  </footer>
  <script>
    const BACKEND_URL = 'https://api-centro-de-compras.onrender.com/api/produtos';

    // Atualizar ano no footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // Verificar autenticação
    const senhaCorreta = 'sua-senha-forte-123'; // Substitua por uma senha forte
    const senha = prompt('Digite a senha para acessar o painel administrativo:');
    if (senha !== senhaCorreta) {
      alert('Acesso não autorizado.');
      window.location.href = '/index.html';
    }

    // Visualizar imagens
    document.getElementById('imagens').addEventListener('change', (e) => {
      const preview = document.getElementById('imagens-preview');
      preview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        if (!file.type.startsWith('image/')) {
          console.error('Arquivo inválido:', file.name);
          return;
        }
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.alt = 'Prévia do produto';
        img.style.maxWidth = '100px';
        img.style.margin = '5px';
        img.onerror = () => { img.src = 'https://via.placeholder.com/100?text=Imagem+Indisponivel'; };
        preview.appendChild(img);
      });
    });

    // Enviar formulário
    document.getElementById('produto-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const feedback = document.getElementById('feedback');
      feedback.textContent = 'Enviando...';
      feedback.style.color = '#333';
      try {
        const formData = new FormData(e.target);
        const imagens = formData.getAll('imagens');
        const imagensBase64 = await Promise.all(
          Array.from(imagens).map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          }))
        );
        const data = {
          nome: formData.get('nome'),
          descricao: formData.get('descricao'),
          categoria: formData.get('categoria'),
          loja: formData.get('loja'),
          link: formData.get('link'),
          preco: formData.get('preco'),
          imagensBase64: imagensBase64,
          rowIndex: formData.get('rowIndex') || undefined
        };
        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          throw new Error(`Erro ${response.status}: ${await response.text()}`);
        }
        const result = await response.json();
        if (result.success) {
          feedback.textContent = 'Produto salvo com sucesso!';
          feedback.style.color = '#2E8B57';
          e.target.reset();
          document.getElementById('imagens-preview').innerHTML = '';
        } else {
          throw new Error(result.error || 'Erro ao salvar produto');
        }
      } catch (error) {
        console.error('Erro:', error);
        feedback.textContent = `Erro: ${error.message}`;
        feedback.style.color = '#d32f2f';
      }
    });
  </script>
</body>
</html>
