<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administração - Centro de Compras</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    .form-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .produto-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; }
    .produto-item img { width: 50px; height: 50px; object-fit: contain; }
    .produto-item button { padding: 5px 10px; background: #ff6200; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .produto-item button:hover { background: #e55a00; }
    #feedback { margin-top: 10px; text-align: center; }
    /* Estilos para o select e botão de envio com base na loja selecionada */
    #loja, #produto-form button[type="submit"] {
      transition: background-color 0.2s, color 0.2s;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #loja.magazineluiza, #produto-form button.magazineluiza {
      background-color: #0074c1;
      color: white;
    }
    #loja.magazineluiza:hover, #produto-form button.magazineluiza:hover {
      background-color: #005fa3;
    }
    #loja.amazon, #produto-form button.amazon {
      background-color: #ff9900;
      color: white;
    }
    #loja.amazon:hover, #produto-form button.amazon:hover {
      background-color: #e68a00;
    }
    #loja.shopee, #produto-form button.shopee {
      background-color: #ee4d2d;
      color: white;
    }
    #loja.shopee:hover, #produto-form button.shopee:hover {
      background-color: #d8401f;
    }
    #loja.shein, #produto-form button.shein {
      background-color: #ff0000;
      color: white;
    }
    #loja.shein:hover, #produto-form button.shein:hover {
      background-color: #cc0000;
    }
    #loja.alibaba, #produto-form button.alibaba {
      background-color: #ff6a00;
      color: white;
    }
    #loja.alibaba:hover, #produto-form button.alibaba:hover {
      background-color: #e65c00;
    }
    #loja.mercadolivre, #produto-form button.mercadolivre {
      background-color: #ffe600;
      color: #333;
    }
    #loja.mercadolivre:hover, #produto-form button.mercadolivre:hover {
      background-color: #e6cc00;
    }
  </style>
</head>
<body>
  <header>
    <h1>Administração de Produtos</h1>
    <a href="/">Voltar ao Início</a>
  </header>
  <main>
    <div class="container admin-container">
      <section class="form-section">
        <h2>Adicionar/Editar Produto</h2>
        <form id="produto-form">
          <input type="hidden" id="produto-id" name="id">
          <label for="nome">Nome:</label>
          <input type="text" id="nome" name="nome" required>
          <label for="descricao">Descrição:</label>
          <textarea id="descricao" name="descricao"></textarea>
          <label for="preco">Preço:</label>
          <input type="number" id="preco" name="preco" step="0.01" required>
          <label for="imagens">Imagens:</label>
          <input type="file" id="imagens" name="imagens" accept="image/*" multiple>
          <div id="imagens-preview"></div>
          <label for="categoria">Categoria:</label>
          <select id="categoria" name="categoria" required>
            <option value="eletronicos">Eletrônicos</option>
            <option value="moda">Moda</option>
            <option value="fitness">Fitness</option>
            <option value="casa">Casa</option>
            <option value="beleza">Beleza</option>
            <option value="esportes">Esportes</option>
            <option value="livros">Livros</option>
            <option value="infantil">Infantil</option>
            <option value="celulares">Celulares</option>
            <option value="eletrodomesticos">Eletrodomésticos</option>
            <option value="pet">Pet</option>
            <option value="jardinagem">Jardinagem</option>
            <option value="automotivo">Automotivo</option>
            <option value="gastronomia">Gastronomia</option>
            <option value="games">Games</option>
          </select>
          <label for="loja">Loja:</label>
          <select id="loja" name="loja" required>
            <option value="magazineluiza.com.br">Magalu</option>
            <option value="amazon.com.br">Amazon</option>
            <option value="shopee.com.br">Shopee</option>
            <option value="br.shein.com">Shein</option>
            <option value="alibaba.com">Alibaba</option>
            <option value="mercadolivre.com.br">Mercado Livre</option>
          </select>
          <label for="link">Link do Produto:</label>
          <input type="url" id="link" name="link" required>
          <button type="submit">Salvar Produto</button>
          <button type="button" id="cancelar-edicao" style="display: none;">Cancelar Edição</button>
          <p id="feedback"></p>
        </form>
      </section>
      <section class="lista-produtos">
        <h2>Lista de Produtos</h2>
        <div id="produtos-lista"></div>
      </section>
    </div>
  </main>
  <script>
    const API_BASE_URL = 'https://minha-api-produtos.onrender.com';

    document.addEventListener('DOMContentLoaded', () => {
      // Manipulador de erro para imagens
      document.querySelectorAll('img').forEach(img => {
        img.onerror = () => {
          console.log(`Erro ao carregar imagem: ${img.src}`);
          img.src = '/imagens/placeholder.jpg';
        };
      });

      // Pré-visualização de imagens
      const imagensInput = document.getElementById('imagens');
      const imagensPreview = document.getElementById('imagens-preview');
      imagensInput.addEventListener('change', () => {
        imagensPreview.innerHTML = '';
        Array.from(imagensInput.files).forEach(file => {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.style.width = '80px';
          img.style.height = '80px';
          img.style.objectFit = 'contain';
          img.style.margin = '5px';
          imagensPreview.appendChild(img);
        });
      });

      // Aplicar cor ao select e botão com base na loja selecionada
      const lojaSelect = document.getElementById('loja');
      const submitButton = document.querySelector('#produto-form button[type="submit"]');
      lojaSelect.addEventListener('change', () => {
        const lojaValue = lojaSelect.value;
        const lojaClasses = {
          'magazineluiza.com.br': 'magazineluiza',
          'amazon.com.br': 'amazon',
          'shopee.com.br': 'shopee',
          'br.shein.com': 'shein',
          'alibaba.com': 'alibaba',
          'mercadolivre.com.br': 'mercadolivre'
        };
        lojaSelect.className = '';
        submitButton.className = '';
        if (lojaClasses[lojaValue]) {
          lojaSelect.classList.add(lojaClasses[lojaValue]);
          submitButton.classList.add(lojaClasses[lojaValue]);
        }
      });
      lojaSelect.dispatchEvent(new Event('change')); // Aplicar cor inicial

      // Carregar lista de produtos
      async function carregarProdutos() {
        const produtosLista = document.getElementById('produtos-lista');
        produtosLista.innerHTML = '<p>Carregando...</p>';
        try {
          const response = await fetch(`${API_BASE_URL}/api/produtos`);
          if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
          const { data } = await response.json();
          produtosLista.innerHTML = '';
          if (data.length === 0) {
            produtosLista.innerHTML = '<p>Nenhum produto encontrado.</p>';
            return;
          }
          data.forEach(produto => {
            const div = document.createElement('div');
            div.className = 'produto-item';
            div.innerHTML = `
              <img src="${produto.imagens[0] || '/imagens/placeholder.jpg'}" alt="${produto.nome}">
              <span>${produto.nome} - R$ ${parseFloat(produto.preco).toFixed(2)}</span>
              <button onclick="editarProduto(${produto.id})">Editar</button>
              <button onclick="excluirProduto(${produto.id})">Excluir</button>
            `;
            produtosLista.appendChild(div);
          });
        } catch (error) {
          console.error('Erro ao carregar produtos:', error);
          produtosLista.innerHTML = '<p>Erro ao carregar produtos.</p>';
        }
      }

      // Editar produto
      window.editarProduto = async function(id) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/produtos?id=${id}`);
          const { data } = await response.json();
          const produto = data.find(p => p.id === id);
          if (!produto) throw new Error('Produto não encontrado');
          
          document.getElementById('produto-id').value = produto.id;
          document.getElementById('nome').value = produto.nome;
          document.getElementById('descricao').value = produto.descricao || '';
          document.getElementById('preco').value = produto.preco;
          document.getElementById('categoria').value = produto.categoria;
          document.getElementById('loja').value = produto.loja;
          document.getElementById('link').value = produto.link;
          document.getElementById('imagens-preview').innerHTML = produto.imagens.map(img => `<img src="${img}" style="width: 80px; height: 80px; object-fit: contain; margin: 5px;">`).join('');
          document.getElementById('cancelar-edicao').style.display = 'inline-block';
          document.querySelector('#produto-form button[type="submit"]').textContent = 'Atualizar Produto';
          lojaSelect.dispatchEvent(new Event('change')); // Atualizar cor ao editar
        } catch (error) {
          console.error('Erro ao carregar produto para edição:', error);
          document.getElementById('feedback').textContent = 'Erro ao carregar produto';
          document.getElementById('feedback').style.color = 'red';
        }
      };

      // Excluir produto
      window.excluirProduto = async function(id) {
        if (!confirm('Tem certeza que deseja excluir este produto?')) return;
        try {
          const response = await fetch(`${API_BASE_URL}/api/produtos/${id}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (response.ok) {
            document.getElementById('feedback').textContent = result.message || 'Produto excluído com sucesso';
            document.getElementById('feedback').style.color = 'green';
            carregarProdutos();
          } else {
            document.getElementById('feedback').textContent = result.message || 'Erro ao excluir produto';
            document.getElementById('feedback').style.color = 'red';
          }
        } catch (error) {
          console.error('Erro ao excluir produto:', error);
          document.getElementById('feedback').textContent = 'Erro ao conectar com a API';
          document.getElementById('feedback').style.color = 'red';
        }
      };

      // Cancelar edição
      document.getElementById('cancelar-edicao').addEventListener('click', () => {
        document.getElementById('produto-form').reset();
        document.getElementById('imagens-preview').innerHTML = '';
        document.getElementById('produto-id').value = '';
        document.getElementById('cancelar-edicao').style.display = 'none';
        document.querySelector('#produto-form button[type="submit"]').textContent = 'Adicionar Produto';
        lojaSelect.dispatchEvent(new Event('change')); // Atualizar cor ao cancelar
      });

      // Formulário de adição/atualização de produto
      const form = document.getElementById('produto-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const id = document.getElementById('produto-id').value;
        const url = id ? `${API_BASE_URL}/api/produtos/${id}` : `${API_BASE_URL}/api/produtos`;
        const method = id ? 'PUT' : 'POST';

        try {
          const response = await fetch(url, {
            method,
            body: formData
          });
          const result = await response.json();
          const feedback = document.getElementById('feedback');
          if (response.ok) {
            feedback.textContent = result.message || id ? 'Produto atualizado com sucesso' : 'Produto adicionado com sucesso';
            feedback.style.color = 'green';
            form.reset();
            document.getElementById('imagens-preview').innerHTML = '';
            document.getElementById('produto-id').value = '';
            document.getElementById('cancelar-edicao').style.display = 'none';
            document.querySelector('#produto-form button[type="submit"]').textContent = 'Adicionar Produto';
            lojaSelect.dispatchEvent(new Event('change')); // Atualizar cor ao salvar
            carregarProdutos();
          } else {
            feedback.textContent = result.message || 'Erro ao salvar produto';
            feedback.style.color = 'red';
          }
        } catch (error) {
          console.error('Erro ao salvar produto:', error);
          document.getElementById('feedback').textContent = 'Erro ao conectar com a API';
          document.getElementById('feedback').style.color = 'red';
        }
      });

      // Carregar produtos iniciais
      carregarProdutos();
    });
  </script>
</body>
</html>
