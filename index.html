const API_CONFIG = {
  REAL_API: "https://minha-api-produtos.onrender.com",
  USE_LOCAL_DATA: false,
  TEST_API: "https://jsonplaceholder.typicode.com",
};

let currentPage = 1;
let allProducts = [];
let isLoading = false;
let currentImageIndex = 0;

const SAMPLE_PRODUCTS = [
  
];

function createImagePlaceholder(width = 300, height = 200, text = "Produto") {
  return `https://via.placeholder.com/${width}x${height}/f0f0f0/999999?text=${encodeURIComponent(text)}`;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ Iniciando Centro de Compras...");
  if (API_CONFIG.USE_LOCAL_DATA) {
    console.log("üì± Modo OFFLINE ativado - usando dados locais");
    showConnectionStatus("offline");
  } else {
    console.log("üåê Modo ONLINE - tentando conectar com API");
    testApiConnection();
  }

  initializeHeader();
  initializeSidebar();
  initializeSearch();
  initializeFilters();
  initializeModal();
  loadProducts();
  updateFooterYear();
  setupLazyLoading();
  setupServiceWorker();
});

async function testApiConnection() {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    const response = await fetch(`${API_CONFIG.REAL_API}/api/health`, {
      method: "GET",
      signal: controller.signal,
      headers: { "Content-Type": "application/json" },
    });
    clearTimeout(timeoutId);
    if (response.ok) {
      console.log("‚úÖ API conectada com sucesso!");
      showConnectionStatus("online");
    } else {
      throw new Error(`API retornou status ${response.status}`);
    }
  } catch (error) {
    console.warn("‚ö†Ô∏è Falha na conex√£o com API, usando modo offline:", error.message);
    API_CONFIG.USE_LOCAL_DATA = true;
    showConnectionStatus("offline");
  }
}

function showConnectionStatus(status) {
  const existingStatus = document.querySelector(".connection-status");
  if (existingStatus) existingStatus.remove();

  const statusDiv = document.createElement("div");
  statusDiv.className = `connection-status ${status}`;
  statusDiv.innerHTML = `
    <div class="status-content">
      <i class="fas fa-${status === "online" ? "wifi" : "exclamation-triangle"}"></i>
      <span>${status === "online" ? "Conectado ao servidor" : "Modo offline - dados de exemplo"}</span>
      ${status === "offline" ? "<small>Configure sua API no arquivo script.js</small>" : ""}
    </div>
  `;
  document.body.appendChild(statusDiv);
  setTimeout(() => statusDiv.remove(), 5000);
}

function initializeHeader() {
  const logo = document.getElementById("site-logo");
  if (logo) {
    let clickCount = 0;
    let clickTimeout = null;
    logo.addEventListener("click", (e) => {
      e.preventDefault();
      clickCount++;
      if (clickCount === 1) {
        clickTimeout = setTimeout(() => clickCount = 0, 1000);
      } else if (clickCount === 3) {
        clearTimeout(clickTimeout);
        window.location.href = "/admin-xyz-123.html";
        clickCount = 0;
      }
    });
  }

  const searchBtn = document.querySelector(".search-btn");
  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      const searchInput = document.getElementById("busca");
      if (searchInput && searchInput.value.trim()) {
        loadProducts(1, false);
      }
    });
  }
}

function initializeSidebar() {
  const categoriesBtn = document.getElementById("categories-toggle");
  const sidebar = document.getElementById("categories-sidebar");
  const overlay = document.getElementById("overlay");
  const closeSidebar = document.getElementById("close-sidebar");

  if (categoriesBtn && sidebar && overlay) {
    categoriesBtn.addEventListener("click", () => {
      sidebar.classList.add("active");
      overlay.classList.add("active");
      document.body.style.overflow = "hidden";
    });

    const closeSidebarHandler = () => {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
      document.body.style.overflow = "";
    };

    if (closeSidebar) closeSidebar.addEventListener("click", closeSidebarHandler);
    overlay.addEventListener("click", closeSidebarHandler);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && sidebar.classList.contains("active")) {
        closeSidebarHandler();
      }
    });

    const categoryItems = document.querySelectorAll(".category-item");
    categoryItems.forEach((item) => {
      item.addEventListener("click", () => {
        categoryItems.forEach((i) => i.classList.remove("active"));
        item.classList.add("active");
        const categoria = item.dataset.categoria;
        loadProducts(1, false);
        closeSidebarHandler();
      });
    });
  }
}

function initializeSearch() {
  const searchInput = document.getElementById("busca");
  if (searchInput) {
    const debouncedSearch = debounce(() => loadProducts(1, false), 500);
    searchInput.addEventListener("input", debouncedSearch);
    searchInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        loadProducts(1, false);
      }
    });
  }
}

function initializeFilters() {
  const storeCards = document.querySelectorAll(".store-card");
  storeCards.forEach((card) => {
    card.addEventListener("click", () => {
      storeCards.forEach((c) => c.classList.remove("active"));
      card.classList.add("active");
      loadProducts(1, false);
    });
  });

  const viewBtns = document.querySelectorAll(".view-btn");
  viewBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      viewBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      const view = btn.dataset.view;
      const productsGrid = document.getElementById("grid-produtos");
      if (productsGrid) {
        productsGrid.className = view === "list" ? "products-list" : "products-grid";
      }
    });
  });

  const sortSelect = document.getElementById("sort-select");
  if (sortSelect) {
    sortSelect.addEventListener("change", () => loadProducts(1, false));
  }

  const loadMoreBtn = document.getElementById("load-more");
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", () => loadProducts(currentPage + 1, true));
  }
}

function initializeModal() {
  const modal = document.getElementById("imageModal");
  const modalClose = document.getElementById("modal-close");
  const modalBackdrop = document.querySelector(".modal-backdrop");

  if (modal && modalClose && modalBackdrop) {
    const closeModal = () => {
      modal.style.display = "none";
      document.body.style.overflow = "";
    };

    modalClose.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
      if (modal.style.display === "flex" && e.key === "Escape") {
        closeModal();
      }
    });

    window.moveModalCarousel = (direction) => {
      const images = document.querySelectorAll("#modalCarrosselImagens img");
      const dots = document.querySelectorAll("#modalCarrosselDots .dot");
      if (images.length === 0) return;

      currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
      const offset = -currentImageIndex * 100;
      document.getElementById("modalCarrosselImagens").style.transform = `translateX(${offset}%)`;
      dots.forEach((dot, index) => {
        dot.classList.toggle("active", index === currentImageIndex);
      });
    };
  }

  const modalPrev = document.getElementById("modalPrev");
  const modalNext = document.getElementById("modalNext");
  if (modalPrev) modalPrev.addEventListener("click", () => window.moveModalCarousel(-1));
  if (modalNext) modalNext.addEventListener("click", () => window.moveModalCarousel(1));
}

async function incrementProductView(productId) {
  if (API_CONFIG.USE_LOCAL_DATA) return;
  try {
    await fetch(`${API_CONFIG.REAL_API}/api/produtos/${productId}/view`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    console.error("Erro ao incrementar visualiza√ß√£o:", error);
  }
}

async function loadProducts(page = 1, append = false) {
  if (isLoading) return;
  isLoading = true;

  const categoria = document.querySelector(".category-item.active")?.dataset.categoria || "todas";
  const loja = document.querySelector(".store-card.active")?.dataset.loja || "todas";
  const busca = document.getElementById("busca")?.value.trim() || "";
  const sort = document.getElementById("sort-select")?.value || "relevance";

  const spinner = document.getElementById("loading-spinner");
  const gridProdutos = document.getElementById("grid-produtos");
  const mensagemVazia = document.getElementById("mensagem-vazia");
  const errorMessage = document.getElementById("error-message");
  const loadMoreButton = document.getElementById("load-more");

  if (spinner) spinner.style.display = "block";
  if (!append && gridProdutos) gridProdutos.innerHTML = "";
  if (mensagemVazia) mensagemVazia.style.display = "none";
  if (errorMessage) errorMessage.style.display = "none";
  if (loadMoreButton) loadMoreButton.style.display = "none";

  try {
    let data, total;

    if (API_CONFIG.USE_LOCAL_DATA) {
      const result = getLocalProducts(page, categoria, loja, busca, sort);
      data = result.data;
      total = result.total;
      console.log(`üì± Dados locais: ${data.length} produtos de ${total} total`);
    } else {
      const url = buildApiUrl(page, categoria, loja, busca, sort);
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      const response = await fetch(url, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
        signal: controller.signal,
      });
      clearTimeout(timeoutId);

      if (!response.ok) throw new Error(`Erro HTTP: ${response.status} - ${await response.text()}`);
      const result = await response.json();
      data = result.data || result.produtos || result;
      total = result.total || data.length;
      console.log(`üåê API: ${data.length} produtos de ${total} total`);

      localStorage.setItem(`produtos_page_${page}_${categoria}_${loja}_${busca}_${sort}`, JSON.stringify({ data, total, timestamp: Date.now() }));
    }

    if (!append) allProducts = [];
    allProducts.push(...data);

    if (allProducts.length === 0) {
      showEmptyState();
    } else {
      renderProducts(data, append);
      if (loadMoreButton && allProducts.length < total) {
        loadMoreButton.style.display = "flex";
      }
    }

    currentPage = page;
    updateResultsTitle(categoria, loja, busca, allProducts.length, total);
  } catch (error) {
    console.error("‚ùå Erro ao carregar produtos:", error);
    const cacheKey = `produtos_page_${page}_${categoria}_${loja}_${busca}_${sort}`;
    const cachedData = localStorage.getItem(cacheKey);
    if (cachedData) {
      const { data, total, timestamp } = JSON.parse(cachedData);
      if (Date.now() - timestamp < 24 * 60 * 60 * 1000) { // Cache v√°lido por 24 horas
        if (!append) allProducts = [];
        allProducts.push(...data);
        renderProducts(data, append);
        updateResultsTitle(categoria, loja, busca, allProducts.length, total);
        showConnectionStatus("offline");
        isLoading = false;
        return;
      }
    }

    if (!API_CONFIG.USE_LOCAL_DATA) {
      console.log("üîÑ Tentando fallback para dados locais...");
      API_CONFIG.USE_LOCAL_DATA = true;
      showConnectionStatus("offline");
      loadProducts(page, append);
      return;
    }

    showErrorState(error.message);
  } finally {
    if (spinner) spinner.style.display = "none";
    isLoading = false;
  }
}

function getLocalProducts(page = 1, categoria = "todas", loja = "todas", busca = "", sort = "relevance") {
  let filteredProducts = [...SAMPLE_PRODUCTS];

  if (categoria !== "todas") {
    filteredProducts = filteredProducts.filter((p) => p.categoria === categoria);
  }

  if (loja !== "todas") {
    filteredProducts = filteredProducts.filter((p) => p.loja === loja);
  }

  if (busca) {
    filteredProducts = filteredProducts.filter((p) =>
      p.nome.toLowerCase().includes(busca.toLowerCase()) ||
      p.descricao.toLowerCase().includes(busca.toLowerCase())
    );
  }

  if (sort === "price-low") {
    filteredProducts.sort((a, b) => a.preco - b.preco);
  } else if (sort === "price-high") {
    filteredProducts.sort((a, b) => b.preco - a.preco);
  } else if (sort === "newest") {
    filteredProducts.sort((a, b) => b.id - a.id);
  }

  const start = (page - 1) * 12;
  const end = start + 12;
  return {
    data: filteredProducts.slice(start, end),
    total: filteredProducts.length,
  };
}

function buildApiUrl(page, categoria, loja, busca, sort) {
  let url = `${API_CONFIG.REAL_API}/api/produtos?page=${page}&limit=12`;
  if (categoria !== "todas") url += `&categoria=${encodeURIComponent(categoria)}`;
  if (loja !== "todas") url += `&loja=${encodeURIComponent(loja)}`;
  if (busca) url += `&busca=${encodeURIComponent(busca)}`;
  if (sort !== "relevance") url += `&sort=${sort}`;
  return url;
}

function updateResultsTitle(categoria, loja, busca, count, total) {
  const title = document.getElementById("ofertas-titulo");
  if (!title) return;

  let titleText = "Ofertas do Dia";
  if (busca) titleText = `Resultados para "${busca}"`;
  else if (categoria !== "todas") titleText = `Ofertas em ${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`;
  else if (loja !== "todas") titleText = `Ofertas da ${loja.charAt(0).toUpperCase() + loja.slice(1)}`;

  title.innerHTML = `<i class="fas fa-fire"></i> ${titleText} (${count} de ${total})`;
}

function showEmptyState() {
  const mensagemVazia = document.getElementById("mensagem-vazia");
  if (mensagemVazia) mensagemVazia.style.display = "block";
}

function showErrorState(message) {
  const errorMessage = document.getElementById("error-message");
  if (errorMessage) {
    errorMessage.querySelector("p").textContent = message || "N√£o foi poss√≠vel carregar os produtos. Verifique sua conex√£o.";
    errorMessage.style.display = "block";
  }
}

function renderProducts(products, append) {
  const gridProdutos = document.getElementById("grid-produtos");
  if (!gridProdutos) return;

  const viewType = document.querySelector(".view-btn.active")?.dataset.view || "grid";

  products.forEach((product) => {
    const imagens = Array.isArray(product.imagens) ? product.imagens : JSON.parse(product.imagens || '[]');
    const productCard = document.createElement("div");
    productCard.className = viewType === "grid" ? "product-card" : "product-card list-view";
    productCard.innerHTML = `
      <div class="product-image">
        <div class="image-carousel">
          <div class="carousel-images" data-id="${product.id}">
            ${imagens.length > 0
              ? imagens.map((img, index) => `<img src="${img}" alt="${product.nome}" class="${index === 0 ? 'active' : ''}" loading="lazy">`).join("")
              : `<img src="${createImagePlaceholder(300, 200, product.nome)}" alt="${product.nome}" loading="lazy">`
            }
          </div>
          ${imagens.length > 1
            ? `
              <button class="carousel-btn prev" data-id="${product.id}">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="carousel-btn next" data-id="${product.id}">
                <i class="fas fa-chevron-right"></i>
              </button>
              <div class="carousel-dots">
                ${imagens.map((_, index) => `<span class="dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join("")}
              </div>
            `
            : ""
          }
        </div>
      </div>
      <div class="product-info">
        <h3 class="product-title">${product.nome}</h3>
        <p class="product-description">${product.descricao.slice(0, 100)}${product.descricao.length > 100 ? "..." : ""}</p>
        <div class="product-price">
          <span class="price">R$ ${Number(product.preco).toFixed(2)}</span>
        </div>
        <div class="product-meta">
          <span class="store">${product.loja.charAt(0).toUpperCase() + product.loja.slice(1)}</span>
          <span class="category">${product.categoria.charAt(0).toUpperCase() + product.categoria.slice(1)}</span>
        </div>
        <a href="${product.link}" target="_blank" class="btn-primary buy-btn" rel="noopener noreferrer">
          <i class="fas fa-shopping-cart"></i>
          Comprar Agora
        </a>
      </div>
    `;
    gridProdutos.appendChild(productCard);

    if (imagens.length > 1) {
      const carousel = productCard.querySelector(`.carousel-images[data-id="${product.id}"]`);
      const prevBtn = productCard.querySelector(`.carousel-btn.prev[data-id="${product.id}"]`);
      const nextBtn = productCard.querySelector(`.carousel-btn.next[data-id="${product.id}"]`);
      const dots = productCard.querySelectorAll(`.carousel-dots .dot`);

      let currentIndex = 0;

      const updateCarousel = (index) => {
        const images = carousel.querySelectorAll("img");
        images.forEach((img, i) => img.classList.toggle("active", i === index));
        dots.forEach((dot, i) => dot.classList.toggle("active", i === index));
        carousel.style.transform = `translateX(-${index * 100}%)`;
      };

      if (prevBtn) prevBtn.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + imagens.length) % imagens.length;
        updateCarousel(currentIndex);
      });

      if (nextBtn) nextBtn.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % imagens.length;
        updateCarousel(currentIndex);
      });

      dots.forEach((dot) => {
        dot.addEventListener("click", () => {
          currentIndex = parseInt(dot.dataset.index);
          updateCarousel(currentIndex);
        });
      });
    }

    const imageContainer = productCard.querySelector(".product-image");
    imageContainer.addEventListener("click", () => {
      showModal(product);
      incrementProductView(product.id);
    });
  });
}

function showModal(product) {
  const modal = document.getElementById("imageModal");
  const modalCarrosselImagens = document.getElementById("modalCarrosselImagens");
  const modalCarrosselDots = document.getElementById("modalCarrosselDots");

  if (!modal || !modalCarrosselImagens || !modalCarrosselDots) return;

  const imagens = Array.isArray(product.imagens) ? product.imagens : JSON.parse(product.imagens || '[]');
  currentImageIndex = 0;

  modalCarrosselImagens.innerHTML = imagens.length > 0
    ? imagens.map((img, index) => `<img src="${img}" alt="${product.nome}" class="${index === 0 ? 'active' : ''}">`).join("")
    : `<img src="${createImagePlaceholder(600, 400, product.nome)}" alt="${product.nome}">`;

  modalCarrosselDots.innerHTML = imagens.length > 0
    ? imagens.map((_, index) => `<span class="dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join("")
    : "";

  modal.style.display = "flex";
  document.body.style.overflow = "hidden";

  const dots = modalCarrosselDots.querySelectorAll(".dot");
  dots.forEach((dot) => {
    dot.addEventListener("click", () => {
      currentImageIndex = parseInt(dot.dataset.index);
      window.moveModalCarousel(0);
    });
  });
}

function updateFooterYear() {
  const yearSpan = document.getElementById("year");
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();
}

function setupLazyLoading() {
  const images = document.querySelectorAll("img[loading='lazy']");
  if ("IntersectionObserver" in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src || img.src;
          observer.unobserve(img);
        }
      });
    });

    images.forEach((img) => imageObserver.observe(img));
  }
}

function setupServiceWorker() {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js").then(() => {
      console.log("Service Worker registrado com sucesso");
    }).catch((error) => {
      console.error("Erro ao registrar Service Worker:", error);
    });
  }
}
