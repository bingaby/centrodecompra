<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adicionar Produto</title>
      <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:; /* Permite imagens de URLs externas e data URIs */
    connect-src 'self' https://script.google.com; /* Crucial para o fetch API */
    font-src 'self';
    object-src 'none';
    base-uri 'self';
  ">
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: #f9f9f9; }
    h1 { text-align: center; color: #333; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
    /* Estilos para todos os inputs de texto, URL, textarea e selects */
    input[type="text"],
    input[type="url"],
    input[type="file"], /* Estilo para input type="file" */
    textarea,
    select {
      width: calc(100% - 20px); /* Ajuste para padding */
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* Garante que padding não aumente a largura total */
      font-size: 16px;
    }
    textarea { resize: vertical; min-height: 80px; } /* Estilo específico para textarea */
    button {
      padding: 12px 25px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 17px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
    }
    button:hover { background-color: #0056b3; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    #message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      display: none; /* Escondido por padrão */
    }
    #message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    #message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  </style>
</head>
<body>
  <h1>Adicionar Produto</h1>
  <form id="produto-form" enctype="multipart/form-data">     <div class="form-group">
      <label for="nome">Nome do Produto</label>
      <input type="text" id="nome" name="nome" required>
    </div>
    <div class="form-group">
      <label for="descricao">Descrição do Produto</label>
      <textarea id="descricao" name="descricao" rows="4"></textarea>
    </div>
    <div class="form-group">
      <label for="preco">Preço (R$)</label>
      <input type="text" id="preco" name="preco" placeholder="Ex: 123.45 ou 123,45" required>
    </div>
    <div class="form-group">
      <label for="link">Link do Produto</label>
      <input type="url" id="link" name="link" placeholder="https://exemplo.com/produto-xyz" required>
    </div>
    <div class="form-group">
      <label for="imagens">Fazer Upload da Imagem</label>
      <input type="file" id="imagens" name="imagens" accept="image/*" required>     </div>
    <div class="form-group">
      <label for="categoria">Categoria</label>
      <select id="categoria" name="categoria" required>
        <option value="">Selecione a Categoria</option>
        <option value="todas">Todas</option>
        <option value="eletronicos">Eletrônicos</option>
        <option value="moda">Moda</option>
        <option value="fitness">Fitness</option>
        <option value="casa">Casa</option>
        <option value="beleza">Beleza</option>
        <option value="esportes">Esportes</option>
        <option value="livros">Livros</option>
        <option value="infantil">Infantil</option>
        <option value="celulares">Celulares</option>
        <option value="eletrodomesticos">Eletrodomésticos</option>
        <option value="pet">Pet</option>
        <option value="jardinagem">Jardinagem</option>
        <option value="automotivo">Automotivo</option>
        <option value="gastronomia">Gastronomia</option>
        <option value="games">Games</option>
      </select>
    </div>
    <div class="form-group">
      <label for="loja">Loja</label>
      <select id="loja" name="loja" required>
        <option value="">Selecione a Loja</option>
        <option value="todas">Todas</option>
        <option value="amazon">Amazon</option>
        <option value="magalu">Magalu</option>
        <option value="shein">Shein</option>
        <option value="shopee">Shopee</option>
        <option value="mercadolivre">Mercado Livre</option>
        <option value="alibaba">Alibaba</option>
      </select>
    </div>
        <button type="submit">Adicionar Produto</button>
    <div id="message"></div>
  </form>

  <script>
    const form = document.getElementById('produto-form');
    const messageDiv = document.getElementById('message');

    // SEU ID DE IMPLANTAÇÃO DO GOOGLE APPS SCRIPT AQUI!
    const DEPLOYMENT_ID = 'AKfycbyq0caZb8YCyN-h6E6Os4usnz_a_-wps06_t11llvaaQnDzv4XtAco4piR8a3uhe1-sng';
    const SCRIPT_URL = `https://script.google.com/macros/s/${DEPLOYMENT_ID}/exec`;

    // --- Verificação de Token de Acesso ---
    const urlParams = new URLSearchParams(window.location.search);
    const tempToken = urlParams.get('tempToken');
    if (tempToken !== 'triple-click-access') {
      alert('Acesso não autorizado. Você será redirecionado.');
      window.location.href = '/index.html'; // Ou sua URL completa: 'https://www.centrodecompra.com.br/index.html'
    }

    // --- Função para exibir mensagens ---
    const showMessage = (text, isError = false) => {
      messageDiv.textContent = text;
      messageDiv.className = isError ? 'error' : 'success';
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.textContent = '';
        messageDiv.className = '';
        messageDiv.style.display = 'none';
      }, 5000);
    };

    // --- Event Listener para Submissão do Formulário ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      showMessage('Enviando produto e imagem...', false);

      const imagemInput = document.getElementById('imagens');
      if (!imagemInput.files[0]) {
        showMessage('Por favor, selecione uma imagem para upload.', true);
        return;
      }

      // Usa FormData para lidar com upload de arquivo
      const formData = new FormData();
      formData.append('nome', form.nome.value);
      formData.append('descricao', form.descricao.value);
      formData.append('preco', form.preco.value);
      formData.append('link', form.link.value);
      formData.append('categoria', form.categoria.value);
      formData.append('loja', form.loja.value);
      // formData.append('tamanho', form.tamanho.value); // REMOVIDO: Campo 'tamanho'
      formData.append('imagens', imagemInput.files[0]); // Adiciona o arquivo Blob

      console.log('Dados do FormData a serem enviados:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData // IMPORTANTE: Envia o FormData diretamente, sem JSON.stringify
          // NÂO adicione 'Content-Type': 'application/json' aqui.
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Resposta do servidor:', result);

          if (result.status === 'success') {
            showMessage('Produto adicionado com sucesso! Imagem salva: ' + result.imageUrl, false);
            form.reset();
          } else {
            showMessage('Erro ao adicionar produto: ' + (result.message || 'Resposta inesperada.'), true);
          }
        } else {
          const errorText = await response.text();
          console.error('Erro na resposta do servidor (status ' + response.status + '):', errorText);
          showMessage('Erro ao adicionar produto: ' + response.statusText + ' (' + response.status + ')', true);
        }
      } catch (error) {
        console.error('Erro de conexão ou sistema:', error);
        showMessage('Erro de conexão ao servidor: ' + error.message, true);
      }
    });
  </script>
</body>
</html>
