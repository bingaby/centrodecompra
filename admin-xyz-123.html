<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciar Produtos - Centro de Compras</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="/imagens/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/imagens/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/imagens/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/imagens/apple-touch-icon.png">
  <style>
    :root {
      --primary-color: #ff6200;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --text-color-dark: #333;
      --background-light: #f8f9fa;
      --border-color: #ddd;
      --shadow-light: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 8px rgba(0,0,0,0.15);
      --border-radius-small: 4px;
      --border-radius-medium: 8px;
      --border-radius-large: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body { 
      font-family: 'Roboto', Arial, sans-serif; 
      background-color: var(--background-light);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .site-header {
      background: linear-gradient(135deg, var(--primary-color), #e55a00);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius-large);
      margin-bottom: 30px;
      box-shadow: var(--shadow-light);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-section img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }

    .header-text h1 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 700;
    }

    .header-text p {
      margin: 5px 0 0;
      opacity: 0.9;
      font-size: 0.95em;
    }

    .logout-button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: var(--border-radius-medium);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .form-section {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-light);
      margin-bottom: 30px;
    }

    .form-section h2 {
      margin: 0 0 20px 0;
      color: var(--text-color-dark);
      font-size: 1.5em;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-color-dark);
      font-size: 0.9em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-medium);
      font-size: 16px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 98, 0, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius-medium);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #e55a00;
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--info-color);
      color: white;
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .alert {
      padding: 15px;
      border-radius: var(--border-radius-medium);
      margin: 15px 0;
      font-weight: 500;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .products-section {
      background: white;
      border-radius: var(--border-radius-large);
      box-shadow: var(--shadow-light);
      overflow: hidden;
    }

    .products-header {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .products-header h2 {
      margin: 0;
      color: var(--text-color-dark);
      font-size: 1.5em;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .product-card {
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-medium);
      padding: 20px;
      transition: all 0.3s ease;
      background: white;
    }

    .product-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .product-name {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--text-color-dark);
      margin: 0;
      flex: 1;
    }

    .product-price {
      background: var(--primary-color);
      color: white;
      padding: 5px 12px;
      border-radius: var(--border-radius-medium);
      font-weight: 600;
      font-size: 0.9em;
    }

    .product-meta {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .product-badge {
      background: var(--info-color);
      color: white;
      padding: 4px 8px;
      border-radius: var(--border-radius-small);
      font-size: 0.8em;
      font-weight: 600;
    }

    .product-badge.categoria {
      background: var(--success-color);
    }

    .product-description {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-images {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .product-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: var(--border-radius-small);
      object-fit: cover;
      cursor: pointer;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .product-thumbnail:hover {
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .product-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .product-actions .btn {
      padding: 8px 16px;
      font-size: 0.9em;
      flex: 1;
      min-width: 80px;
      justify-content: center;
    }

    .product-link {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9em;
    }

    .product-link:hover {
      text-decoration: underline;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
    }

    .pagination .btn {
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .pagination .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .page-info {
      font-weight: 600;
      color: var(--text-color-dark);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
      border-radius: var(--border-radius-medium);
      overflow: hidden;
    }

    .modal-image {
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #e55a00;
      transform: scale(1.1);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      margin: 0 0 10px 0;
      font-size: 1.5em;
      color: var(--text-color-dark);
    }

    .empty-state p {
      margin: 0;
      font-size: 1.1em;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
        padding: 15px;
      }
      
      .product-actions {
        flex-direction: column;
      }
      
      .form-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <div class="header-content">
        <div class="logo-section">
          <img src="/imagens/logoscentrodecompras.jpeg" alt="Centro de Compras" onerror="this.style.display='none'">
          <div class="header-text">
            <h1>Gerenciar Produtos</h1>
            <p>Adicione, edite ou remova produtos do portal</p>
          </div>
        </div>
        <button class="logout-button" onclick="AppManager.logout()">
          <span>🚪</span> Sair
        </button>
      </div>
    </header>

    <div class="form-section">
      <h2 id="form-title">➕ Adicionar Produto</h2>
      <form id="product-form">
        <input type="hidden" id="product-id">
        
        <div class="form-grid">
          <div class="form-group">
            <label for="product-name">Nome do Produto *</label>
            <input type="text" id="product-name" required maxlength="100">
          </div>
          
          <div class="form-group">
            <label for="product-price">Preço (R$) *</label>
            <input type="number" id="product-price" step="0.01" min="0" required>
          </div>
          
          <div class="form-group">
            <label for="product-category">Categoria *</label>
            <select id="product-category" required>
              <option value="">Selecione uma categoria</option>
              <option value="eletronicos">Eletrônicos</option>
              <option value="moda">Moda</option>
              <option value="fitness">Fitness</option>
              <option value="casa">Casa e Decoração</option>
              <option value="beleza">Beleza</option>
              <option value="esportes">Esportes</option>
              <option value="livros">Livros</option>
              <option value="infantil">Infantil</option>
              <option value="celulares">Celulares</option>
              <option value="eletrodomesticos">Eletrodomésticos</option>
              <option value="pet">Pet</option>
              <option value="jardinagem">Jardinagem</option>
              <option value="automotivo">Automotivo</option>
              <option value="gastronomia">Gastronomia</option>
              <option value="games">Games</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="product-store">Loja *</label>
            <select id="product-store" required>
              <option value="">Selecione uma loja</option>
              <option value="amazon">Amazon</option>
              <option value="magalu">Magalu</option>
              <option value="shein">Shein</option>
              <option value="shopee">Shopee</option>
              <option value="mercadolivre">Mercado Livre</option>
              <option value="alibaba">Alibaba</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="product-link">Link do Produto *</label>
            <input type="url" id="product-link" required placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label for="product-images">Imagens (máx. 3)</label>
            <input type="file" id="product-images" accept="image/*" multiple>
          </div>
        </div>
        
        <div class="form-group">
          <label for="product-description">Descrição *</label>
          <textarea id="product-description" required maxlength="500" placeholder="Descreva o produto..."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="submit-btn">
            <span>➕</span> Adicionar Produto
          </button>
          <button type="button" class="btn btn-secondary" id="cancel-btn" onclick="AppManager.cancelEdit()" style="display: none;">
            <span>❌</span> Cancelar
          </button>
        </div>
      </form>
    </div>

    <div class="alert alert-success" id="success-alert"></div>
    <div class="alert alert-danger" id="error-alert"></div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Carregando produtos...</p>
    </div>

    <div class="products-section">
      <div class="products-header">
        <h2>📦 Produtos Cadastrados</h2>
      </div>
      
      <div class="products-grid" id="products-grid">
        <!-- Produtos serão inseridos aqui -->
      </div>
      
      <div class="pagination">
        <button class="btn btn-secondary" id="prev-btn" onclick="AppManager.previousPage()">
          <span>⬅️</span> Anterior
        </button>
        <span class="page-info" id="page-info">Página 1 de 1</span>
        <button class="btn btn-secondary" id="next-btn" onclick="AppManager.nextPage()">
          Próximo <span>➡️</span>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="image-modal">
    <div class="modal-content">
      <button class="modal-close" onclick="AppManager.closeModal()">✕</button>
      <img class="modal-image" id="modal-image" src="" alt="Imagem ampliada">
    </div>
  </div>

  <script>
    // Configuração da aplicação
    const CONFIG = {
      API_URL: 'https://centrodecompra-backend.onrender.com',
      ITEMS_PER_PAGE: 12,
      MAX_IMAGES: 3,
      MAX_RETRIES: 3,
      TIMEOUT: 15000
    };

    // Gerenciador de aplicação
    class AppManager {
      constructor() {
        this.state = {
          products: [],
          currentPage: 1,
          totalProducts: 0,
          isLoading: false,
          isEditing: false,
          editingId: null
        };
        this.init();
      }

      init() {
        this.checkAuth();
        this.setupEventListeners();
        this.loadProducts();
      }

      checkAuth() {
        const tempToken = new URLSearchParams(window.location.search).get('tempToken');
        if (tempToken === 'triple-click-access') {
          sessionStorage.setItem('adminToken', 'temp-token-' + Date.now());
        } else if (!sessionStorage.getItem('adminToken')) {
          this.showError('Acesso não autorizado. Clique três vezes no logotipo na página inicial.');
          setTimeout(() => window.location.href = '/index.html', 2000);
        }
      }

      setupEventListeners() {
        document.getElementById('product-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleFormSubmit();
        });

        // Fechar modal clicando fora
        document.getElementById('image-modal').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            this.closeModal();
          }
        });

        // Escape key para fechar modal
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.closeModal();
          }
        });
      }

      async loadProducts() {
        this.setLoading(true);
        this.hideAlerts();

        try {
          const response = await this.makeRequest(
            `/api/produtos?page=${this.state.currentPage}&limit=${CONFIG.ITEMS_PER_PAGE}`
          );

          if (response.produtos) {
            this.state.products = response.produtos;
            this.state.totalProducts = response.total || response.produtos.length;
            this.renderProducts();
            this.updatePagination();
          } else {
            throw new Error('Formato de resposta inválido');
          }
        } catch (error) {
          console.error('Erro ao carregar produtos:', error);
          this.showError(`Erro ao carregar produtos: ${error.message}`);
          this.renderEmptyState();
        } finally {
          this.setLoading(false);
        }
      }

      async makeRequest(endpoint, options = {}) {
        const token = sessionStorage.getItem('adminToken');
        const url = `${CONFIG.API_URL}${endpoint}`;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              ...options.headers
            }
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              this.handleAuthError();
              return;
            }
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`);
          }

          return await response.json();
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Requisição expirou. Tente novamente.');
          }
          throw error;
        }
      }

      handleAuthError() {
        sessionStorage.removeItem('adminToken');
        this.showError('Sessão expirada. Redirecionando...');
        setTimeout(() => window.location.href = '/index.html', 2000);
      }

      renderProducts() {
        const grid = document.getElementById('products-grid');
        
        if (!this.state.products || this.state.products.length === 0) {
          this.renderEmptyState();
          return;
        }

        grid.innerHTML = this.state.products.map(product => this.createProductCard(product)).join('');
      }

      createProductCard(product) {
        const price = parseFloat(product.preco || 0).toFixed(2).replace('.', ',');
        const images = Array.isArray(product.imagens) ? product.imagens : [];
        const thumbnails = images.length > 0 
          ? images.map(img => `<img src="${this.escapeHtml(img)}" class="product-thumbnail" onclick="AppManager.openModal('${this.escapeHtml(img)}')" onerror="this.style.display='none'">`).join('')
          : '<div style="color: #999; font-size: 0.9em;">Sem imagens</div>';

        return `
          <div class="product-card">
            <div class="product-header">
              <h3 class="product-name">${this.escapeHtml(product.nome || 'Produto sem nome')}</h3>
              <div class="product-price">R$ ${price}</div>
            </div>
            
            <div class="product-meta">
              <span class="product-badge categoria">${this.escapeHtml(product.categoria || 'Sem categoria')}</span>
              <span class="product-badge">${this.escapeHtml(product.loja || 'Sem loja')}</span>
            </div>
            
            <div class="product-description">
              ${this.escapeHtml(product.descricao || 'Sem descrição')}
            </div>
            
            <div class="product-images">
              ${thumbnails}
            </div>
            
            <div class="product-actions">
              <a href="${this.escapeHtml(product.link || '#')}" target="_blank" class="product-link">🔗 Ver produto</a>
              <button class="btn btn-info" onclick="AppManager.editProduct('${product._id}')">
                <span>✏️</span> Editar
              </button>
              <button class="btn btn-danger" onclick="AppManager.deleteProduct('${product._id}', '${this.escapeHtml(product.nome)}')">
                <span>🗑️</span> Excluir
              </button>
            </div>
          </div>
        `;
      }

      renderEmptyState() {
        const grid = document.getElementById('products-grid');
        grid.innerHTML = `
          <div class="empty-state">
            <h3>📦 Nenhum produto encontrado</h3>
            <p>Comece adicionando seu primeiro produto usando o formulário acima.</p>
          </div>
        `;
      }

      async editProduct(id) {
        try {
          const product = await this.makeRequest(`/api/produtos/${id}`);
          
          this.state.isEditing = true;
          this.state.editingId = id;
          
          document.getElementById('form-title').textContent = '✏️ Editar Produto';
          document.getElementById('product-id').value = id;
          document.getElementById('product-name').value = product.nome || '';
          document.getElementById('product-description').value = product.descricao || '';
          document.getElementById('product-category').value = product.categoria || '';
          document.getElementById('product-store').value = product.loja || '';
          document.getElementById('product-link').value = product.link || '';
          document.getElementById('product-price').value = product.preco || '';
          
          document.getElementById('submit-btn').innerHTML = '<span>💾</span> Salvar Alterações';
          document.getElementById('cancel-btn').style.display = 'inline-block';
          
          // Scroll para o formulário
          document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          this.showError(`Erro ao carregar produto: ${error.message}`);
        }
      }

      async deleteProduct(id, name) {
        if (!confirm(`Confirma a exclusão do produto "${name}"?`)) return;

        try {
          await this.makeRequest(`/api/produtos/${id}`, { method: 'DELETE' });
          this.showSuccess('Produto excluído com sucesso!');
          this.loadProducts();
        } catch (error) {
          this.showError(`Erro ao excluir produto: ${error.message}`);
        }
      }

      async handleFormSubmit() {
        const formData = this.getFormData();
        
        if (!this.validateForm(formData)) return;

        try {
          this.setLoading(true);
          
          let imageUrls = [];
          const imageFiles = document.getElementById('product-images').files;
          
          if (imageFiles.length > 0) {
            if (imageFiles.length > CONFIG.MAX_IMAGES) {
              this.showError(`Máximo de ${CONFIG.MAX_IMAGES} imagens permitidas`);
              return;
            }
            imageUrls = await this.uploadImages(imageFiles);
          } else if (this.state.isEditing) {
            // Manter imagens existentes se estiver editando
            const existingProduct = await this.makeRequest(`/api/produtos/${this.state.editingId}`);
            imageUrls = existingProduct.imagens || [];
          }
