<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-adsense-account" content="ca-pub-4531749081462125">
  <meta name="description" content="Centro de Compras - Administra√ß√£o: Gerencie produtos, cadastre novas ofertas e administre o portal de compras do Brasil.">
  <meta name="keywords" content="administra√ß√£o, centro de compras, cadastro de produtos, ofertas, Brasil">
  <meta name="robots" content="noindex">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Centro de Compras - Administra√ß√£o">
  <meta name="twitter:description" content="Gerencie produtos e ofertas no maior portal de compras do Brasil.">
  <meta name="twitter:image" content="/logos/logoscentrodecompras.webp">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'nonce-secure123' https://pagead2.googlesyndication.com https://www.gstatic.com https://script.google.com https://script.googleusercontent.com https://www.googletagmanager.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
    img-src 'self' data: https://*.googleusercontent.com https://firebasestorage.googleapis.com https://res.cloudinary.com;
    font-src 'self' https://fonts.gstatic.com;
    connect-src 'self' https://api.cloudinary.com https://script.google.com https://script.googleusercontent.com https://firebase.googleapis.com https://firebaseinstallations.googleapis.com;
  ">
  <title>Centro de Compras - Administra√ß√£o</title>
  <link rel="preload" href="/logos/logoscentrodecompras.webp" as="image" type="image/webp">
  <link rel="preload" href="/style.css" as="style" onload="this.rel='stylesheet';this.onload=null">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" media="print" onload="this.media='all'">
  <link rel="icon" type="image/png" sizes="32x32" href="/logos/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/logos/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/logos/apple-touch-icon.png">
</head>
<body>
  <header class="site-header" role="banner">
    <div class="logo-container">
      <picture>
        <source srcset="/logos/logoscentrodecompras.webp" type="image/webp">
        <img src="/logos/logoscentrodecompras.png" alt="Logotipo do Centro de Compras" id="site-logo-img" width="150" height="50">
      </div>
    </div>
    <div class="header-text">
      <h1>Centro de Compras - Administra√ß√£o</h1>
      <p>Gerencie os produtos do portal</p>
    </div>
  </header>

  <nav role="navigation" aria-label="Menu principal">
    <a href="/index.html">Voltar para Promo√ß√µes</a>
    <a href="/cupom.html">Cupom de Desconto</a>
    <a href="/sobre.html">Sobre</a>
    <a href="/contato.html">Contato</a>
  </nav>

  <main role="main" aria-label="Conte√∫do principal">
    <section class="cadastro">
      <h2>Cadastro de Produtos</h2>
      <form id="form-produto" aria-describedby="form-data">
        <div class="form-group">
          <label for="nome">Nome do Produto:</label>
          <input type="text" id="nome" required aria-required="true" placeholder="Digite o nome do produto">
        </div>
        
        <div class="form-group">
          <label for="descricao">Descri√ß√£o:</label>
          <textarea id="textInput" required aria-required="true" placeholder="Descreva o produto"></textarea>
        </div>
        
        <div class="form-group">
          <label for="categoria">Categoria:</label>
          <select id="categoria" required aria-required="true">
            <option value="">Selecione uma categoria</option>
            <option value="eletronicos">Eletr√¥nicos</option>
            <option value="moda">Moda</option>
            <option value="fitness">Fitness</option>
            <option value="casa">Casa</option>
            <option value="beleza">Beleza</option>
            <option value="esportes">Esportes</option>
            <option value="livros">Livros</option>
            <option value="infantil">Infantil</option>
            <option value="celulares">Celulares</option>
            <option value="eletrodomesticos">Eletrodom√©sticos</option>
            <option value="pet">Pet</option>
            <option value="jardinagem">Jardinagem</option>
            <option value="automotivo">Automotivo</option>
            <option value="gastronomia">Gastronomia</option>
            <option value="games">Games</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="loja">Loja:</label>
          <select id="loja" required aria-required="true">
            <option value="">Selecione uma loja</option>
            <option value="mercadolivre">Mercado Livre</option>
            <option value="amazon">Amazon</option>
            <option value="magalu">Magazine Luiza</option>
            <option value="shein">Shein</option>
            <option value="shopee">Shopee</option>
            <option value="alibaba">Alibaba</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="preco">Pre√ßo (R$):</label>
          <input type="number" id="preco" step="0.01" min="0" required aria-required="true" placeholder="Ex.: 99.90">
        </div>
        
        <div class="form-group">
          <label for="imagem">Imagem:</label>
          <input type="file" id="imagem" accept="image/*" required aria-required="true">
          <img id="preview" alt="Pr√©-visualiza√ß√£o da imagem do produto">
          <div class="loading-spinner" id="image-upload-spinner" style="display: none;">
            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            <span class="sr-only">Enviando imagem...</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="link">Link do Produto:</label>
          <input type="url" id="link" placeholder="https://www.exemplo.com" required aria-required="true">
        </div>
        
        <button type="submit" id="submit-button" aria-label="Cadastrar produto">Cadastrar Produto</button>
      </form>
      <div id="feedback" class="error-message" aria-live="polite"></div>
    </section>
  </main>

  <footer role="contentinfo">
    <p>üîß Todos os direitos reservados <strong>Grupo Centro de Compras "CdC"</strong> ¬© <span id="year"></span></p>
  </footer>

  <script type="module" nonce="secure123">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDryJc0Y7JV_Os5JaFUEtJ7wDk",
      authDomain: "centro-de-compra-5fa91.firebaseapp.com",
      projectId: "centro-de-compra-5fa91",
      storageBucket: "centro-de-compra-5fa91.firebasestorage.app",
      messagingSenderId: "276696026262",
      appId: "1:276696026262:web:979a68c0796ea1d17346b7",
      measurementId: "G-PM11NQL61N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Verifica se usu√°rio est√° autenticado
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = '/login.html?redirect=/add-produto.html';
      }
    });
  </script>
  <script nonce="secure123">
    document.addEventListener('DOMContentLoaded', () => {
      // Atualiza o ano no rodap√©
      document.getElementById('year').textContent = new Date().getFullYear();

      const cloudName = 'centrodecompra';
      const unsignedUploadPreset = 'ml_default';
      const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzxU2q5ApfQk/0FawUDSfLFskikcggALJWWS0zSfYAA/exec';

      const form = document.getElementById('form-produto');
      const imagemInput = document.getElementById('imagem');
      const preview = document.getElementById('preview');
      const feedback = document.getElementById('feedback');
      const submitButton = document.getElementById('submit-button');
      const imageUploadSpinner = document.getElementById('image-upload-spinner');
      
      let imagemUrl = '';
      let isUploadingImage = false;

      imagemInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) {
          feedback.textContent = 'Por favor, escolha uma imagem.';
          feedback.className = 'error message';
          return;
        }

        // Valida√ß√£o de tamanho (m√°ximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
          feedback.textContent = 'A imagem deve ter no m√°ximo 5MB.';
          feedback.className = 'error message';
          return;
        }

        if (!file.type.startsWith('image/')) {
          feedback.textContent = 'Por favor, selecione um arquivo de imagem v√°lido.';
          feedback.className = 'error message';
          return;
        }

        feedback.textContent = 'Imagem sendo carregada...';
        feedback.className = 'error message';
        preview.style.display = 'none';
        submitButton.disabled = true;
        imageUploadSpinner.style.display = 'flex';
        isUploadingImage = true;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', unsignedUploadPreset);
        formData.append('folder', 'centro-de-compra/produtos');
        formData.append('tags', 'produto,centrodecompras');
        formData.append('transformation', 'q_auto,f_webp,w_400');

        try {
          const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
          });

          if (!res.ok) throw new Error(`Erro ${res.status}: Falha ao enviar imagem`);

          }

          const data = await res.json();
          imagemUrl = data.secure_url;
          preview.src = imagemUrl;
          preview.style.display = 'block';
          feedback.textContent = 'Imagem carregada com sucesso!';
          feedback.className = 'success message';
        } catch (err) {
          imagemUrl = '';
          feedback.textContent = `Erro ao enviar imagem: ${err.message}. Tente novamente.';
          feedback.className = 'error message';
          console.error('Erro no upload:', err);
        } finally {
          imageUploadSpinner.style.display = 'none';
          isUploadingImage = false;
          submitButton.disabled = false;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (isUploadingImage) {
          feedback.textContent = 'Aguarde o upload da imagem antes de enviar o produto.';
          feedback.className = 'error message';
          return;
        }

        if (!imagemUrl) {
          feedback.textContent = 'Por favor, selecione e aguarde o upload da imagem.';
          feedback.className = 'error message';
          return;
        }

        const nome = document.getElementById('nome').value.trim();
        const descricao = document.getElementById('descricao').value.trim();
        const categoria = document.getElementById('categoria').value;
        const loja = document.getElementById('loja').value;
        const preco = parseFloat(document.getElementById('preco').value);
        const link = document.getElementById('link').value.trim();

        // Valida√ß√£o avan√ßada
        if (!nome || nome.length < 3) {
          feedback.textContent = 'O nome do produto deve ter pelo menos 3 caracteres.';
          feedback.className = 'error message';
          return;
        }
        if (!descricao || descricao.length < 10) {
          feedback.textContent = 'A descri√ß√£o deve ter pelo menos 10 caracteres.';
          feedback.className = 'error message';
          return;
        }
        if (!categoria) {
          feedback.textContent = 'Selecione uma categoria v√°lida.';
          feedback.className = 'error message';
          return;
        }
        if (!loja) {
          feedback.textContent = 'Selecione uma loja v√°lida.';
          feedback.className = 'error message';
          return;
        }
        if (isNaN(preco) || preco <= 0) {
          feedback.textContent = 'O pre√ßo deve ser um n√∫mero positivo.';
          feedback.className = 'error message';
          return;
        }
        if (!link || !/^(https?:\/\/[^\s$.?#].[^\s]*)$/.test(link)) {
          feedback.textContent = 'Insira um link v√°lido come√ßando com http ou https.';
          feedback.className = 'error message';
          return;
        }

        const produto = {
          nome,
          descricao,
          categoria,
          loja,
          preco,
          imagem: imagemUrl,
          link,
          createdAt: new Date().toISOString()
        };

        submitButton.disabled = true;
        feedback.textContent = 'Cadastrando produto...';
        feedback.className = 'info message';

        try {
          const response = await fetch(appsScriptUrl, {
            method: 'POST',
            body: JSON.stringify(produto),
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const result = await response.json();

          if (result.status === 'success') {
            feedback.textContent = 'Produto cadastrado com sucesso!';
            feedback.className = 'success message';
            form.reset();
            preview.src = '';
            preview.style.display = 'none';
            imagemUrl = '';
          } else {
            feedback.textContent = `Erro ao cadastrar: ${result.message || 'Erro desconhecido'}`;
            feedback.className = 'error message';
          }
        } catch (err) {
          feedback.textContent = 'Erro de conex√£o com o servidor. Tente novamente.';
          feedback.className = 'error message';
          console.error('Erro:', err);
        } finally {
          submitButton.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
