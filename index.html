<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Ofertas com descontos reais nas principais lojas como Amazon, Shein, Shopee, Magalu, Mercado Livre e Alibaba." />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
    font-src https://fonts.gstatic.com;
    script-src 'self' 'unsafe-inline';
    img-src 'self' https://drive.google.com https://*.googleusercontent.com data:;
    connect-src 'self' https://opensheet.vercel.app https://script.google.com
  ">
  <title>CentrodeCompra - Ofertas do Dia</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
  <header class="site-header">
    <div class="logo-container">
      <img src="logos/logoscentrodecompras.jpeg" alt="CentrodeCompra" />
    </div>
    <div class="header-text">
      <h1>CentrodeCompra</h1>
      <p>Encontre as melhores ofertas do Brasil!</p>
    </div>
  </header>

  <nav>
    <a href="./index.html">Promo√ß√µes</a>
    <a href="./cupom.html">Cupons</a>
    <a href="./sobre.html">Sobre</a>
    <a href="./contato.html">Contato</a>
  </nav>

  <div class="container">
    <aside class="sidebar-categorias">
      <h3>Categorias</h3>
      <ul>
        <li class="categoria-item ativa" data-categoria="todas" onclick="filtrarPorCategoria('todas')">Todas</li>
        <li class="categoria-item" data-categoria="eletronicos" onclick="filtrarPorCategoria('eletronicos')">Eletr√¥nicos</li>
        <li class="categoria-item" data-categoria="moda" onclick="filtrarPorCategoria('moda')">Moda</li>
        <li class="categoria-item" data-categoria="casa" onclick="filtrarPorCategoria('casa')">Casa</li>
      </ul>
    </aside>

    <main>
      <section id="ofertas-section">
        <h2>üõçÔ∏è Ofertas do Dia</h2>
        <div class="lojas-parceiras">
          <h3>üåü Lojas Parceiras</h3>
          <div class="grid-lojas">
            <div class="loja-todas ativa" onclick="filtrarPorLoja('todas')" role="button">Todas</div>
            <div class="loja" data-loja="amazon" onclick="filtrarPorLoja('amazon')" role="button">
              <img src="logos/amazon.png" alt="Amazon" loading="lazy" />
              <span class="amazon">Amazon</span>
            </div>
            <div class="loja" data-loja="shopee" onclick="filtrarPorLoja('shopee')" role="button">
              <img src="logos/shopee.png" alt="Shopee" loading="lazy" />
              <span class="shopee">Shopee</span>
            </div>
          </div>
        </div>
        <input type="text" id="busca" placeholder="Busque por produtos..." class="barra-busca" />
        <div id="busca-feedback" class="busca-feedback">Buscando...</div>
        <div class="loading-spinner" id="loading-spinner">Carregando...</div>
        <div class="grid-lojas" id="grid-produtos"></div>
        <p class="mensagem-vazia" id="mensagem-vazia">Nenhum produto encontrado.</p>
      </section>
    </main>
  </div>

  <footer>
    <p>üîß Todos os direitos reservados <strong>Grupo CentrodeCompra "CdC"</strong> ¬© <span id="year"></span></p>
    <div id="admin-login">
      <input type="password" id="admin-password" placeholder="Senha de admin" aria-label="Senha de administrador">
      <button onclick="verificarSenha()">Acessar Administra√ß√£o</button>
    </div>
  </footer>

  <script>
    const PLANILHA_URL = 'https://opensheet.vercel.app/1SMpUcrobcuWVGq4F_3N59rhs2_GpDo2531_2blpwEhs/Produtos';
    let produtos = [];
    let categoriaSelecionada = 'todas';
    let lojaSelecionada = 'todas';
    let termoBusca = '';

    function normalizarString(str) {
      return str?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') || '';
    }

    function atualizarAnoFooter() {
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    function verificarSenha() {
      const senhaCorreta = 'admin123'; // Substitua por uma senha forte em produ√ß√£o
      const input = document.getElementById('admin-password');
      if (input.value === senhaCorreta) {
        window.location.href = './admin-xyz-123.html?token=admin-access';
      } else {
        alert('Senha incorreta!');
      }
    }

    async function carregarProdutos() {
      const loadingSpinner = document.getElementById('loading-spinner');
      const mensagemVazia = document.getElementById('mensagem-vazia');
      loadingSpinner.style.display = 'block';
      try {
        const response = await fetch(PLANILHA_URL);
        if (!response.ok) throw new Error(`Erro ${response.status}: Falha ao carregar produtos`);
        produtos = await response.json();
        filtrarProdutos();
      } catch (error) {
        mensagemVazia.textContent = 'Erro ao carregar produtos: ' + error.message;
        mensagemVazia.style.display = 'block';
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    function filtrarProdutos() {
      const gridProdutos = document.getElementById('grid-produtos');
      const mensagemVazia = document.getElementById('mensagem-vazia');
      const produtosFiltrados = produtos.filter((produto) => {
        const matchCategoria = categoriaSelecionada === 'todas' ||
          normalizarString(produto.categoria) === normalizarString(categoriaSelecionada);
        const matchLoja = lojaSelecionada === 'todas' ||
          normalizarString(produto.loja) === normalizarString(lojaSelecionada);
        const matchBusca = !termoBusca ||
          normalizarString(produto.nome).includes(normalizarString(termoBusca));
        return matchCategoria && matchLoja && matchBusca;
      });

      gridProdutos.innerHTML = '';
      if (produtosFiltrados.length === 0) {
        mensagemVazia.style.display = 'block';
        return;
      }

      mensagemVazia.style.display = 'none';
      produtosFiltrados.forEach((produto) => {
        const imagens = produto.imagens?.split(',').filter(img => img.trim()) || ['imagens/placeholder.jpg'];
        const produtoDiv = document.createElement('div');
        produtoDiv.classList.add('produto-card', 'visible');
        produtoDiv.innerHTML = `
          <img src="${imagens[0]}" alt="${produto.nome || 'Produto'}" loading="lazy" />
          <span>${produto.nome || 'Produto sem nome'}</span>
          <span class="descricao">Loja: ${produto.loja || 'Desconhecida'}</span>
          <p class="preco">${produto.preco ? `R$ ${produto.preco}` : 'Ver pre√ßo'}</p>
          <a href="${produto.link || '#'}" target="_blank" class="ver-na-loja ${produto.loja ? normalizarString(produto.loja) : ''}">Comprar</a>
        `;
        gridProdutos.appendChild(produtoDiv);
      });
    }

    function filtrarPorCategoria(categoria) {
      categoriaSelecionada = categoria;
      document.querySelectorAll('.categoria-item').forEach(item => item.classList.remove('ativa'));
      document.querySelector(`.categoria-item[data-categoria="${categoria}"]`).classList.add('ativa');
      filtrarProdutos();
    }

    function filtrarPorLoja(loja) {
      lojaSelecionada = loja;
      document.querySelectorAll('.loja, .loja-todas').forEach(item => item.classList.remove('ativa'));
      document.querySelector(`[data-loja="${loja}"]`)?.classList.add('ativa') || document.querySelector('.loja-todas').classList.add('ativa');
      filtrarProdutos();
    }

    function configurarBusca() {
      const buscaInput = document.getElementById('busca');
      buscaInput.addEventListener('input', (e) => {
        termoBusca = e.target.value;
        document.getElementById('busca-feedback').style.display = termoBusca ? 'block' : 'none';
        filtrarProdutos();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('P√°gina carregada em:', window.location.href);
      carregarProdutos();
      configurarBusca();
      atualizarAnoFooter();
    });
  </script>
</body>
</html>
